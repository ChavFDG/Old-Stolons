function UpdateBillConfirm(e){return confirm(e)?!0:!1}function initMap(e){var t=[44.7177685,4.596498399999973],i={},o=L.map("map").setView(t,11),d='<a href="http://openstreetmap.org">OpenStreetMap</a>';L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Map data &copy; "+d,maxZoom:24}).addTo(o);var s=L.icon({iconUrl:"/images/mapMarker.png",iconSize:[38,95],shadowSize:[50,64],iconAnchor:[22,94],shadowAnchor:[4,62],popupAnchor:[-3,-76]});e.forEach(function(e){var t=L.popup().setContent("<b>"+e.get("CompanyName")+"</b><br />Cliquer pour voir les détails."),d=L.marker([e.get("Latitude"),e.get("Longitude")],{icon:s});d.bindPopup(t),d.on("click",function(){return ProducerModalView.open(e.get("Id")),!1}),d.addTo(o),i[e.get("Id")]=d}),PublicProducers.selectProducer=function(e){var t=PublicProducers.ProducersModel.get(e);0!=t.get("Latitude")&&0!=t.get("Longitude")&&(o.panTo([t.get("Latitude"),t.get("Longitude")]),i[e].openPopup())}}function initModels(){PublicProducts.ProductTypesModel=new ProductTypesModel,PublicProducts.ProductsModel=new ProductsModel}function initViews(){window.ProductModalView=new ProductModalView,window.ProducerModalView=new ProducerViewModal,PublicProducts.FiltersView=new FiltersView({model:PublicProducts.ProductTypesModel,productsModel:PublicProducts.ProductsModel}),PublicProducts.ProductsView=new ProductsView({model:PublicProducts.ProductsModel})}ProductTypesModel=Backbone.Collection.extend({url:"/api/ProductTypes",initialize:function(){this.fetch()}}),ManageProductView=Backbone.View.extend({el:"body",events:{"change #SellType":"sellTypeChanged","input #Product_QuantityStep":"updatePriceField","input #price":"updatePriceField","change #hideVolumePrice":"toggleVolumePriceField"},initialize:function(){this.sellTypeChanged()},sellTypeChanged:function(){var e=$("#SellType").val();1==e?($("#productWeightUnit").addClass("hidden"),$("#productQtyStep").addClass("hidden"),$("#productAvgWeight").addClass("hidden"),$("#pieceHideVolumePrice").removeClass("hidden")):($("#productWeightUnit").removeClass("hidden"),$("#productQtyStep").removeClass("hidden"),$("#productAvgWeight").removeClass("hidden"),$("#pieceHideVolumePrice").addClass("hidden")),this.updatePriceField(),this.updateVolumePriceField()},updatePriceField:function(){var e=$("#SellType").val();if(1==e)$("#unitPrice").removeAttr("readonly");else{$("#unitPrice").attr("readonly",!0);var t=$("#price").val(),i=$("#Product_QuantityStep").val();t&&i&&($("#unitPrice").val(t*i/1e3),$("#unitPrice").attr("value",t*i/1e3))}},updateVolumePriceField:function(){var e=$("#hideVolumePrice").is(":checked"),t=$("#SellType").val(),i=$("#price").val();e||1!=t||0!=i?($("#hideVolumePrice").prop("checked",!1),$("#price").removeAttr("readonly")):($("#hideVolumePrice").prop("checked",!0),$("#price").attr("readonly",!0))},toggleVolumePriceField:function(){var e=$("#SellType").val(),t=$("#hideVolumePrice").is(":checked");t?($("#price").attr("readonly",!0),$("#price").val(0)):$("#price").removeAttr(1!=e?"readonly":"readonly")}}),ProductTypesView=Backbone.View.extend({el:"#famillySelect",template:_.template($("#familiesTemplate").html()),initialize:function(e){this.model=e.model,this.listenTo(this.model,"sync change",this.render),this.selectedFamily="Tous"},onOptionSelected:function(e){this.selectedFamily=e.params.data.id||"Tous"},selectElemTemplate:function(e){if(!e.id)return e.text;var t=$(e.element).data("image");return t?$('<span class="select-option"><img src="/'+t+'" />'+$(e.element).text()+"</span>"):e.text},render:function(){var e=$("#productFamilly").text()||"Tous";e=e.trim(),this.$el.html(this.template({currentFamilly:e,productTypes:this.model.toJSON()})),this.$("#familiesDropDown").select2({minimumResultsForSearch:1/0,templateResult:this.selectElemTemplate,templateSelection:this.selectElemTemplate}),this.$("#familiesDropDown").on("select2:select",_.bind(this.onOptionSelected,this))}}),$(function(){{var e=new ProductTypesModel;new ProductTypesView({model:e}),new ManageProductView({})}}),ProductModel=Backbone.Model.extend({idAttribute:"Id",defaults:{},unitsEnum:["Kg","L"],getPictureUrl:function(){var e=this.get("Pictures");return _.isEmpty(e)||_.isEmpty(e[0])?"/images/panier.jpg":e[0]},getSellTypeString:function(){return 0==this.get("Type")?"Au poids":1==this.get("Type")?"À la pièce":2==this.get("Type")?"Emballé":"Error"},getStockUnitString:function(){if(1==this.get("Type"))return"Pièces";var e=this.get("ProductUnit");return this.unitsEnum[e]},getUnitPriceString:function(){return 1==this.get("Type")?this.get("UnitPrice")+" € l'unité":this.get("UnitPrice")+" € pour "+this.get("QuantityStepString")},getVolumePriceString:function(){var e=this.get("ProductUnit");return 0===this.get("Price")||1e3===this.get("QuantityStep")?"":"("+this.get("Price")+" € / "+this.unitsEnum[e]+")"},getSellStepString:function(){if(1==this.get("Type"))return" Pièce(s)";this.get("ProductUnit")},prettyPrintQuantity:function(e){return e>=1e3?e/1e3+" "+largeunit:e+" "+productUnit}}),window.PublicProducers={},PublicProducers=window.PublicProducers,ProducerModel=Backbone.Model.extend({"default":{},idAttribute:"Id"}),ProducersModel=Backbone.Collection.extend({url:"/api/producers",model:ProducerModel,initialize:function(){this.fetch()}}),ProducerViewModal=Backbone.View.extend({el:"#producerModal",template:_.template($("#producerModalTemplate").html()),initialize:function(){},open:function(e){this.currentProducer=PublicProducers.ProducersModel.get(e),this.renderModal()},onClose:function(){this.currentProducer=null,this.$el.off("hide.bs.modal"),this.$el.empty()},render:function(){this.$el.html(this.template({producer:this.currentProducer.toJSON()}))},renderModal:function(){this.render(),this.$el.modal({keyboard:!0,show:!0}),this.$el.on("hide.bs.modal",_.bind(this.onClose,this))}}),$(function(){window.ProducerModalView=new ProducerViewModal,PublicProducers.ProducersModel=new ProducersModel,PublicProducers.ProducersModel.on("sync",function(){initMap(PublicProducers.ProducersModel)})}),window.PublicProducts={},PublicProducts=window.PublicProducts,ProductTypesModel=Backbone.Collection.extend({url:"/api/ProductTypes",initialize:function(){this.fetch()}}),ProductsModel=Backbone.Collection.extend({defaults:[],model:ProductModel,url:"/api/Products",initialize:function(){this.fetch()}}),ProducerViewModal=Backbone.View.extend({el:"#producerModal",template:_.template($("#producerModalTemplate").html()),initialize:function(){},open:function(e){this.currentProducer=PublicProducts.ProductsModel.get(e).get("Producer"),this.renderModal()},onClose:function(){this.currentProducer=null,this.$el.off("hide.bs.modal"),this.$el.empty()},render:function(){this.$el.html(this.template({producer:this.currentProducer}))},renderModal:function(){this.render(),this.$el.modal({keyboard:!0,show:!0}),this.$el.on("hide.bs.modal",_.bind(this.onClose,this))}}),ProductModalView=Backbone.View.extend({el:"#productModal",template:_.template($("#productModalTemplate").html()),open:function(e){this.currentProduct=PublicProducts.ProductsModel.get(e),this.renderModal()},onClose:function(){this.currentProduct=null,this.$el.off("hide.bs.modal"),this.$el.empty()},render:function(){this.$el.html(this.template({product:this.currentProduct.toJSON(),productModel:this.currentProduct}))},renderModal:function(){this.render(),this.$el.modal({keyboard:!0,show:!0}),this.$el.on("hide.bs.modal",_.bind(this.onClose,this))}}),FiltersView=Backbone.View.extend({el:"#filters",template:_.template($("#filtersTemplate").html()),initialize:function(e){this.model=e.model,this.productsModel=e.productsModel,this.listenTo(this.model,"sync change",this.render),this.selectedFamily="Tous"},onOptionSelected:function(e){this.selectedFamily=e.params.data.id||"Tous",this.filterProducts()},famillyMatch:function(e){return"Tous"==this.selectedFamily||e.Familly&&e.Familly.FamillyName==this.selectedFamily},productNameMatch:function(e,t){return _.isEmpty(t)||-1!=e.Name.toLowerCase().indexOf(t)},productDescMatch:function(e,t){return _.isEmpty(t)||-1!=e.Description.toLowerCase().indexOf(t)},filterProducts:function(){var e=this.$("#search").val();e=e.toLowerCase();var t=0;this.productsModel.forEach(function(i){var o=i.toJSON();this.famillyMatch(o)&&(this.productNameMatch(o,e)||this.productDescMatch(o,e))?($("#product-"+o.Id).removeClass("hidden"),t++):$("#product-"+o.Id).removeClass("hidden").addClass("hidden")},this),0===t?$("#emptyProducts").removeClass("hidden"):$("#emptyProducts").addClass("hidden")},selectElemTemplate:function(e){if(!e.id)return e.text;var t=$(e.element).data("image");return t?$('<span class="select-option"><img src="'+t+'" />'+$(e.element).text()+"</span>"):e.text},render:function(){this.$el.html(this.template({productTypes:this.model.toJSON()})),this.$("#familiesDropDown").select2({minimumResultsForSearch:1/0,templateResult:this.selectElemTemplate,templateSelection:this.selectElemTemplate}),this.$("#familiesDropDown").on("select2:select",_.bind(this.onOptionSelected,this)),this.$("#search").on("input",_.bind(function(){this.filterProducts()},this))}}),ProductView=Backbone.View.extend({template:_.template($("#productTemplate").html()),initialize:function(e){this.productId=e.productId,this.el=e.el,this.model=e.model,this.model.on("sync change",this.render,this)},render:function(){this.$el.html(this.template({product:this.model.toJSON(),productModel:this.model}))}}),ProductsView=Backbone.View.extend({el:"#products",template:_.template($("#productsTemplate").html()),initialize:function(e){this.model=e.model,this.model.on("sync",this.render,this),this.views={}},render:function(){this.$el.html(this.template({products:this.model.models})),this.model.forEach(function(e){var t=new ProductView({el:"#product-"+e.get("Id"),model:e});this.views[e.get("Id")]=t,t.render()},this)}}),$(function(){initModels(),initViews()}),window.WeekBasket={},WeekBasket=window.WeekBasket,ProductTypesModel=Backbone.Collection.extend({url:"/api/ProductTypes",initialize:function(){this.fetch()}}),ProductsModel=Backbone.Collection.extend({defaults:[],model:ProductModel,url:"/api/Products",initialize:function(){this.fetch()}}),TmpWeekBasketModel=Backbone.Model.extend({url:"/api/TmpWeekBasket",idAttribute:"Id",isEmpty:function(){return _.isEmpty(this.get("Products"))},canPurchase:function(){return!_.isEmpty(this.get("Id"))},getTotal:function(){var e=0;return _.forEach(this.get("Products"),function(t){var i=WeekBasket.ProductsModel.get(t.ProductId);e+=t.Quantity*i.get("Price")}),e},getProductEntry:function(e){var t;return _.forEach(this.get("Products"),function(i){return i.ProductId==e?(t=i,!1):void 0}),t},addProductToBasket:function(e){var t=this;return $.ajax({url:"/api/addtobasket",data:{productId:e,weekBasketId:t.get("Id")},type:"post",success:function(e){e&&t.set(JSON.parse(e))}})},incrementProduct:function(e){var t=this;return $.ajax({url:"/api/incrementProduct",data:{productId:e,weekBasketId:t.get("Id")},type:"post",success:function(e){e&&t.set(JSON.parse(e))}})},decrementProduct:function(e){var t=this;return $.ajax({url:"/api/decrementProduct",data:{productId:e,weekBasketId:t.get("Id")},type:"post",success:function(e){e&&t.set(JSON.parse(e))}})},removeBillEntry:function(e){var t=this;return $.ajax({url:"/api/removeBillEntry",data:{productId:e,weekBasketId:t.get("Id")},type:"post",success:function(e){e&&t.set(JSON.parse(e))}})},resetBasket:function(){var e=this;return $.ajax({url:"/api/resetBasket",data:{weekBasketId:e.get("Id")},type:"post",success:function(t){console.log("Reset basket response: ",t),e.set(JSON.parse(t))}})}}),ValidatedWeekBasketModel=Backbone.Model.extend({url:"/api/validatedWeekBasket",initialize:function(){this.fetch()},getTotal:function(){var e=0;return _.forEach(this.get("Products"),function(t){var i=WeekBasket.ProductsModel.get(t.ProductId);console.log("Bill ProductId  = "+t.ProductId),e+=t.Quantity*i.get("Price")}),e},exists:function(){return!_.isEmpty(this.get("Products"))},isEmpty:function(){return _.isEmpty(this.get("Products"))},getProductEntry:function(e){var t;return _.forEach(this.get("Products"),function(i){return i.ProductId==e?(t=i,!1):void 0}),t}});var initModels=function(){WeekBasket.ProductsModel=new ProductsModel,WeekBasket.ProductTypesModel=new ProductTypesModel,WeekBasket.ValidatedWeekBasketModel=new ValidatedWeekBasketModel,WeekBasket.TmpWeekBasketModel=new TmpWeekBasketModel,WeekBasket.ProductsModel.on("sync",function(){WeekBasket.TmpWeekBasketModel.fetch()})};FiltersView=Backbone.View.extend({el:"#filters",template:_.template($("#filtersTemplate").html()),initialize:function(e){this.model=e.model,this.productsModel=e.productsModel,this.listenTo(this.model,"sync change",this.render),this.selectedFamily="Tous"},onOptionSelected:function(e){this.selectedFamily=e.params.data.id||"Tous",this.filterProducts()},famillyMatch:function(e){return"Tous"==this.selectedFamily||e.Familly&&e.Familly.FamillyName==this.selectedFamily},productNameMatch:function(e,t){return _.isEmpty(t)||-1!=e.Name.toLowerCase().indexOf(t)},productDescMatch:function(e,t){return _.isEmpty(t)||-1!=e.Description.toLowerCase().indexOf(t)},filterProducts:function(){var e=this.$("#search").val();e=e.toLowerCase();var t=0;this.productsModel.forEach(function(i){var o=i.toJSON();this.famillyMatch(o)&&(this.productNameMatch(o,e)||this.productDescMatch(o,e))?($("#product-"+o.Id).removeClass("hidden"),t++):$("#product-"+o.Id).removeClass("hidden").addClass("hidden")},this),0===t?$("#emptyProducts").removeClass("hidden"):$("#emptyProducts").addClass("hidden")},selectElemTemplate:function(e){if(!e.id)return e.text;var t=$(e.element).data("image");return t?$('<span class="select-option"><img src="'+t+'" />'+$(e.element).text()+"</span>"):e.text},render:function(){this.$el.html(this.template({productTypes:this.model.toJSON()})),this.$("#familiesDropDown").select2({minimumResultsForSearch:1/0,templateResult:this.selectElemTemplate,templateSelection:this.selectElemTemplate}),this.$("#familiesDropDown").on("select2:select",_.bind(this.onOptionSelected,this)),this.$("#search").on("input",_.bind(function(){this.filterProducts()},this))}}),ProductModalView=Backbone.View.extend({el:"#productModal",template:_.template($("#productModalTemplate").html()),initialize:function(){},open:function(e){this.currentProduct=WeekBasket.ProductsModel.get(e),WeekBasket.TmpWeekBasketModel.on("sync change",this.render,this),this.renderModal()},onClose:function(){this.currentProduct=null,this.$el.off("hide.bs.modal"),this.$el.empty(),WeekBasket.TmpWeekBasketModel.off("sync change",this.render,this)},render:function(){this.$el.html(this.template({product:this.currentProduct.toJSON(),productModel:this.currentProduct}))},renderModal:function(){this.render(),this.$el.modal({keyboard:!0,show:!0}),this.$el.on("hide.bs.modal",_.bind(this.onClose,this))}}),ProducerModalView=Backbone.View.extend({el:"#producerModal",template:_.template($("#producerModalTemplate").html()),open:function(e){this.renderModal(WeekBasket.ProductsModel.get(e).get("Producer"))},onClose:function(){this.currentProduct=null,this.$el.off("hide.bs.modal"),this.$el.empty()},renderModal:function(e){this.$el.html(this.template({producer:e})),this.$el.modal({keyboard:!0,show:!0}),this.$el.on("hide.bs.modal",_.bind(this.onClose,this))}}),ProductView=Backbone.View.extend({template:_.template($("#productTemplate").html()),initialize:function(e){this.productId=e.productId,this.el=e.el,this.model=e.model,this.model.on("sync change",this.render,this)},render:function(){this.$el.html(this.template({product:this.model.toJSON(),productModel:this.model}))}}),ProductActionView=Backbone.View.extend({template:_.template($("#productActionTemplate").html()),events:{"click .minus":"decrement","click .plus":"increment","click .addProductBtn":"addToBasket"},initialize:function(e){this.el=e.el,this.productId=e.productId,this.model=e.model,this.model.on("sync change",this.basketChanged,this)},basketChanged:function(){this.billEntry=this.model.getProductEntry(this.productId),this.render()},canIncrement:function(){if(!this.billEntry)return!1;var e=WeekBasket.ValidatedWeekBasketModel.getProductEntry(this.productId),t=e&&e.Quantity||0,i=this.billEntry.Quantity-t;return i<this.billEntry.Product.RemainingStock},canAddToBasket:function(){var e=WeekBasket.ValidatedWeekBasketModel.getProductEntry(this.productId),t=e&&e.Quantity||0,i=WeekBasket.ProductsModel.get(this.productId);return this.billEntry?!1:i.get("RemainingStock")+t>0?!0:!1},addToBasket:function(){return this.$(".productQuantityChanger").addClass("hidden"),this.$(".productQuantityLoading").removeClass("hidden"),WeekBasket.TmpWeekBasketModel.addProductToBasket(this.productId).then(_.bind(function(){this.$(".productQuantityChanger").removeClass("hidden"),this.$(".productQuantityLoading").addClass("hidden")},this)),!1},increment:function(){return this.$(".productQuantityChanger").addClass("hidden"),this.$(".productQuantityLoading").removeClass("hidden"),WeekBasket.TmpWeekBasketModel.incrementProduct(this.productId).then(_.bind(function(){this.$(".productQuantityLoading").addClass("hidden"),this.$(".productQuantityChanger").removeClass("hidden")},this)),!1},decrement:function(){return this.$(".productQuantityChanger").addClass("hidden"),this.$(".productQuantityLoading").removeClass("hidden"),WeekBasket.TmpWeekBasketModel.decrementProduct(this.productId).then(_.bind(function(){this.$(".productQuantityLoading").addClass("hidden"),this.$(".productQuantityChanger").removeClass("hidden")},this)),!1},render:function(){this.$el.html(this.template({billEntry:this.billEntry,canAddToBasket:_.bind(this.canAddToBasket,this),canIncrement:_.bind(this.canIncrement,this)}))}}),ProductsView=Backbone.View.extend({el:"#products",template:_.template($("#productsTemplate").html()),initialize:function(e){this.model=e.model,this.model.on("sync",this.render,this),this.tmpBasketModel=e.tmpBasketModel,this.views={}},render:function(){this.$el.html(this.template({products:this.model.models})),this.model.forEach(function(e){var t=new ProductView({el:"#product-"+e.get("Id"),model:e});this.views[e.get("Id")]=t,t.render();var i=new ProductActionView({model:this.tmpBasketModel,productId:e.get("Id"),el:"#product-"+e.get("Id")+" .pr_actions"});i.render()},this)}}),TmpWeekBasketView=Backbone.View.extend({el:"#tmpBasket",template:_.template($("#tmpWeekBasketTemplate").html()),initialize:function(e){this.model=e.model,this.model.on("sync change",this.render,this),this.validatedBasketModel=e.validatedBasketModel},render:function(){this.$el.html(this.template({tmpBasketModel:this.model,tmpBasket:this.model.toJSON(),validatedBasketModel:this.validatedBasketModel}))}}),ValidatedWeekBasketView=Backbone.View.extend({el:"#validatedBasket",template:_.template($("#validatedWeekBasketTemplate").html()),events:{"click .validatedBasketCollapse":"toggleCollapse"},initialize:function(e){this.model=e.model,this.model.on("sync",this.render,this),this.tmpBasketModel=e.tmpBasketModel,this.tmpBasketModel.on("sync change",this.render,this)},toggleCollapse:function(){this.collapse(this.$("#collapsible").hasClass("in")?!0:!1)},collapse:function(e){e?(this.$("#collapsible").collapse("hide"),this.$(".glyphicon-collapse-up").addClass("hidden"),this.$(".glyphicon-collapse-down").removeClass("hidden")):(this.$("#collapsible").collapse("show"),this.$(".glyphicon-collapse-up").removeClass("hidden"),this.$(".glyphicon-collapse-down").addClass("hidden"))},render:function(){this.$el.html(this.template({tmpBasket:this.tmpBasketModel.toJSON(),validatedBasketModel:this.model,validatedBasket:this.model.toJSON()}))}});var initViews=function(){window.ProductModalView=new ProductModalView,window.ProducerModalView=new ProducerModalView,WeekBasket.FiltersView=new FiltersView({model:WeekBasket.ProductTypesModel,productsModel:WeekBasket.ProductsModel}),WeekBasket.ValidatedWeekBasketView=new ValidatedWeekBasketView({model:WeekBasket.ValidatedWeekBasketModel,tmpBasketModel:WeekBasket.TmpWeekBasketModel}),WeekBasket.ProductsView=new ProductsView({model:WeekBasket.ProductsModel,tmpBasketModel:WeekBasket.TmpWeekBasketModel}),WeekBasket.TmpWeekBasketView=new TmpWeekBasketView({model:WeekBasket.TmpWeekBasketModel,validatedBasketModel:WeekBasket.ValidatedWeekBasketModel,validatedBasketView:WeekBasket.ValidatedWeekBasketView})},bootstrapWeekBasket=function(){initModels(),initViews()};$(function(){bootstrapWeekBasket()});