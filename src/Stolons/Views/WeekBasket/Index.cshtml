@using Stolons.Helpers;
@using Stolons.ViewModels.WeekBasket;
@model WeekBasketViewModel

@{
	ViewData["Title"] = "Mon panier";
}

<h2>@ViewData["Title"]</h2>

<div class="weekBasketContainer">

  <div class="row">

    <div class="col-lg-3">
      <div id="baskets">
	<div id="validatedBasket">
	</div>
	<div id="tmpBasket">
	</div>
      </div>
    </div>

    <div class="products col-lg-9">
     
      <div id="filters">
      </div>

      <div id="products">
      </div>

    </div>
  </div>
</div>

<div id="productModal" class="modal fade"></div>
<div id="producerModal" class="modal fade"></div>

<!-- below are templates definitions to be rendered under placeholders defined above -->

<script id="filtersTemplate" type="text/template">

  <fieldset>

    <label class="control-label" for="familiesDropDown">Famille : </label>
    <select id="familiesDropDown" name="familiesDropDown">

      <option value="Tous">Tous</option>

      <% _.forEach(productTypes, function(productType) { %>

      <optgroup label="<%= productType.Name %>">

	<% _.forEach(productType.ProductFamilly, function (productFamily) { %>

	<option id="<%= productFamily.FamillyName %>" value="<%= productFamily.FamillyName %>" data-image="<%= productFamily.Image %>"> <%= productFamily.FamillyName %> </option>

	<% }); %>

      </optgroup>
	
      <% }); %>
    </select>

    <div class="searchFilter">
      <label>Recherche :</label>
      <input id="search" type="text">
    </div>

  </fieldset>

</script>

<script id="productTemplate" type="text/template">
  <div class="product">
    <div class="product-top">
      <div class="pr_img product-top" data-toggle="tooltip" title="Voir détails produit">
        <a href="#" onclick="WeekBasket.ProductModalView.open('<%= product.Id %>');return false;">
          <img src="<%= product.Pictures[0] %>" />
        </a>
      </div>
      <div class="pr_avatar" data-toggle="tooltip" title="Voir détails producteur">
	<a href="#" onclick="WeekBasket.ProducerModalView.open('<%= product.Id %>');return false;">
	  <img class="avatar" src="<%= product.Producer.Avatar %>" />
	</a>
      </div>
      <div class="pr_labels">
	<% _.forEach(product.LabelsSerialized.split(';'), function(label) { %>
	<div class="pr_label">
          <img src="/images/labels/<%= label %>.jpg" />
        </div>
        <% }); %>
      </div>
    </div>
    <div class="product-bottom">
      <div class="pr_text">
        <div class="pr_name">
          <%= product.Name %>
        </div>
        <div class="pr_qtystock">
          <span class="pr_stock">
            Stock: <b> <%= product.RemainingStock %></b>
          </span>
          <span class="pr_priceQuantity">
            <b>
              <%= product.Price %> €
            </b>
          </span>
        </div>
	<div class="pr_actions">
	</div>
      </div>
    </div>
  </div>
</script>

<script id="productActionTemplate" type="text/template">

  <% if (!billEntry) { %>
  <div class="addProduct">
    <button type="button" class="btn btn-default addProductBtn">Ajouter au panier</button>
  </div>
  <% } else { %>
  <div class="productQuantityChanger">
    <a href="#" class="minus">
      <img src="/images/basket-remove.png" />
    </a>
    <span class="quantity">
      <%= billEntry.Quantity %>
    </span>

    <% if (canIncrement()) { %>
    <a href="#" class="plus">
      <img src="/images/basket-add.png" />
    </a>
    <% } %>
  </div>
  <% } %>

  <div class="productQuantityLoading hidden">
    <span class="glyphicon glyphicon-refresh glyphicon-refresh-animate">
    </span>
  </div>

</script>

<script id="productsTemplate" type="text/template">

  <% _.forEach(products, function(productModel) { %>
  <div id="product-<%= productModel.get('Id') %>">
  </div>
  <% }); %>

</script>

<script id="productModalTemplate" type="text/template">
  <div id="productModal-<%= product.Id %>" class="modals">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div id="productModal-info" class="col-md-8">
              <h3><%= product.Name %></h3>
              <ul>
		Type de vente:
		<li><b>
		    <%= productModel.getSellTypeString() %>
		</b></li>
                <li>
                  Stock:
                  <b>
                    <%= product.RemainingStock %>
		    <%= productModel.getStockUnitString() %>
                  </b>
                </li>
              </ul>
            </div>
	    <div class="col-md-4">
              <div id="productModal-img" class="pr_img">
		<img src="<%= product.Pictures[0] %>" />
              </div>
	      <div>
		<% _.forEach(product.LabelsSerialized.split(';'), function(label) { %>
		<div class="pr_label">
		  <img src="/images/labels/<%= label %>.jpg" />
		</div>
		<% }); %>
	      </div>
	    </div>
          </div>
          <div id="productModal-pricing" class="row">
            <div>
              <span>
                Prix:
                <b>
                  <%= product.Price %> €
		  <%= productModel.getPriceUnitString() %>
                </b>
              </span>
            </div>
          </div>
          <div id="productModal-desc" class="row">
            <span><b>Description: </b><pre> <%= product.Description %> </pre></span>
          </div>
          <div id="productModal-actions" class="row pr_actions">
          </div>
        </div>
      </div>
    </div>
  </div>
</script>

<script id="producerModalTemplate" type="text/template">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      </div>
      <div class="modal-body">
	Hello je suis '<%= producer.CompanyName %>'
      </div>
    </div>
  </div>
</script>

<script id="validatedWeekBasketTemplate" type="text/template">

  <div class="basketTitle">
    <a class="validatedBasketCollapse" href="#">
      <span class="glyphicon glyphicon-collapse-up">
      </span>
      <span class="glyphicon glyphicon-collapse-down hidden">
      </span>
      <b>Produits validés</b>
    </a>
  </div>

  <div id="collapsible" class="collapse in">
    <table class="table basketTable">
      <tr class="basketHeader">
	<th>
          Produit
	</th>
	<th>
          <span class="glyphicon glyphicon-th" data-toggle="tooltip" title="Quantité">
	  </span>
	</th>
	<th>
	  <span class="glyphicon glyphicon-euro" data-toggle="tooltip" title="Prix en euros">
          </span>
	</th>
	<th>
	  <span class="glyphicon glyphicon-eye-open" data-toggle="tooltip" title="Cliquer pour voir le détail produit">
	  </span>
	</th>
      </tr>

      <% if (validatedBasketModel.exists()) { %>
      <% _.forEach(validatedBasket.Products, function(entry) { %>
      <tr class="billEntry">
	<td>
          <%= entry.Product.Name %>
	</td>
	<td>
          <span> <%= entry.Quantity %> </span>
	</td>
	<td>
          <span> <%= entry.Quantity * entry.Product.Price %> </span>
	</td>
	<td>
	  <a href="#" onclick="WeekBasket.ProductModalView.open('<%= entry.Product.Id %>');return false;">
            <span class="glyphicon glyphicon-eye-open">
	    </span>
	  </a>
	</td>
      </tr>
      <% });
	 } else { %>
      <tr>
	<td colspan="4">
	  <b>Aucun produit validé</b>
	</td>
      </tr>
      <% } %>
      <tr>
	<td colspan="2">
	  <b>Total : </b>
	</td>
	<td>
	  <b>
	    <%= validatedBasketModel.getTotal() %>
	  </b>
	</td>
	<td></td>
      </tr>
    </table>
  </div>
  <hr />
</script>

<script id="tmpWeekBasketTemplate" type="text/template">

  <% if ((!tmpBasket.Validated && !tmpBasketModel.isEmpty()) || (validatedBasketModel.exists() && tmpBasketModel.isEmpty())) { %>

  <p class="basketTitle"><b>Panier non validé</b></p>

  <table class="table basketTable">
    <tr class="basketHeader">
      <th>
        Produit
      </th>
      <th>
        <span class="glyphicon glyphicon-th" data-toggle="tooltip" title="Quantité">
	</span>
      </th>
      <th>
	<span class="glyphicon glyphicon-euro" data-toggle="tooltip" title="Prix en euros">
          </span>
      </th>
      <th>
	<span class="glyphicon glyphicon-trash" data-toggle="tooltip" title="Cliquer pour supprimer le produit du panier">
	</span>
      </th>
    </tr>

    <% _.forEach(tmpBasket.Products, function(entry) { %>

    <tr class="billEntry">
      <td>
	<a href="#" onclick="WeekBasket.ProductModalView.open('<%= entry.ProductId %>');return false;">
	  <%= entry.Product.Name %>
	</a>
      </td>
      <td>
        <span> <%= entry.Quantity %></span>
      </td>
      <td>
        <span> <%= entry.Quantity * entry.Product.Price %> </span>
      </td>
      <td data-toggle="tooltip" title="Cliquer pour supprimer le produit du panier">
	<a href="#" class="deleteEntry" onclick="WeekBasket.TmpWeekBasketModel.removeBillEntry('<%= entry.ProductId %>');return false;">
          <span class="glyphicon glyphicon-trash">
	  </span>
	</a>
      </td>
    </tr>
    <% }); %>
    <% if (tmpBasket.Products.length === 0) { %>
    <tr>
      <td colspan="5">
	<b>Aucun produit dans le panier</b>
      </td>
    </tr>
    <% } %>
    <tr>
      <td colspan="2">
	<b>Total : </b>
      </td>
      <td>
	<b>
	  <%= tmpBasketModel.getTotal() %>
	</b>
      </td>
      <td>
      </td>
      <td>
      </td>
    </tr>
  </table>

  <div class="basketValidation">
    <form action="WeekBasket/ValidateBasket" method="post">
      <div class="hidden">
        <input name="basketId" value="<%= tmpBasket.Id %>" class="form-control" />
      </div>

      <% if (tmpBasketModel.isEmpty() && validatedBasketModel.exists()) { %>
      <input type="submit" value="Annuler mon panier" class="btn btn-default" />
      <%  } else { %>
      <input type="submit" value="Valider mon panier" class="btn btn-default" />
      <% }%>
    </form>
  </div>

  <% } %>

</script>

<script src="/js/weekbasket.js"></script>
